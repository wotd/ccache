language: c
cache: ccache
sudo: required
addons:
  apt:
    packages:
      - asciidoc
      - libxslt1-dev
      - xsltproc
      - docbook-xml
      - docbook-xsl
      - gperf
      - elfutils
      - zlib1g-dev
      - libmemcached-dev
      - libmemcached-tools
      - memcached
      - mingw32
      - mingw32-binutils
      - clang
os:
  - linux
  - osx
compiler:
  - clang
  - gcc
env:
  global:
    - XML_CATALOG_FILES=/usr/local/etc/xml/catalog
matrix:
  include:
    - os: linux
      compiler: gcc
      sudo: required
      dist: trusty
      env: FEATURES="--enable-memcached"
    - os: linux
      compiler: clang
      env: FEATURES="--enable-memcached"
    - os: linux
      compiler: clang
      env: CFLAGS="-fsanitize=undefined" ASAN_OPTIONS="detect_leaks=0"
    - os: linux
      compiler: clang
      env: CFLAGS="-fsanitize=address -g" ASAN_OPTIONS="detect_leaks=0"
    - os: linux
      compiler: clang
      env: PATH="/usr/bin:$PATH" TEST=analyze
    - os: linux
      compiler: gcc
      env: CUDA=8.0.61-1
    - os: osx
      osx_image: xcode8.3
      compiler: clang
      env: FEATURES=" --enable-memcached --with-bundled-zlib"
    - os: osx
      osx_image: xcode9
      compiler: clang
      env: FEATURES="--enable-memcached --with-bundled-zlib"
  exclude:
    - os: osx
      compiler: gcc
before_install:
  - source ./.travis/install_cuda.sh
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then brew update; fi
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then brew install asciidoc libmemcached; fi
script:
  - "./autogen.sh"
  - "./configure --prefix $(pwd)/build $HOST $FEATURES"
  - make
  - make ${TEST:-test}
  - make package
before_deploy:
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; export FILE_TO_UPLOAD="$(pwd)/bundle/ccache.dmg"; fi
deploy: 
  provider: releases
  api_key:
    - secure: F94cuUIlII4r077jgelBBQhzjKb/7pGFPFDzHIGfZGSNIA7tqdhL6wZ8Aj9cqxzn91LQfqGJX1bd3sEKRautdg6HDqMdKJ20UhG41EylDXsTPCgb9qCRlH+cKo9wY/QZnH7lAhiKkMtou4L33HdKRV+qKa7j8QEPGwpoGpGE1Bj1ppLkak4sU7wx1v1GiXAbEK/Turqmrp9FgkeAz76xSWCNYaa+2co/SDdolgLu+EXiWVcprxXpbXFWTY8s6XRilJFdPjEd2a9qJ1jpXe1PUGeqv0DhFE25FJTCnkmsbIQCzSP18HGANR48oP/hna81HXOvPQJL/idvLZj/G/uLcCWbcM5uy62jvjW5dh7wMRzvqwDwHKBSjZC/bzbQ3idba6ff5TbcC0vyLUkzuPOpo0v8l1cl+YhVyh3Sck3IBORdziFBPCKfurdGG34w8ISQ8M3XuKFAO27qXJffpxOoh2L77wtvQeYKJnOPgVUrQHJtBWcDj1hV1xAN8BPv/ApY14CqkEHRaQbHsZst+G6D0FDvl9hme/1HWmc2ARdfhsQLgz050wQ/kEn9syc6AHbNdm1x4HDZwkdrYrkEr4BK+505fpoTS1gS1ssYswPQ760Vp49I6SItaqf2UJS7jfS81xgOxoWFqzTPUC+zxQbboe6nE6KkTxtZZSns83SJm1Y=
  file: "${FILE_TO_UPLOAD}"
  skip_cleanup: true
  overwrite: true
  on: feature/macosdistribution
    tags: true
